## <a name="meaning-of-migration-of-iaas-resources-from-classic-to-resource-manager"></a>將 IaaS 資源從傳統移轉至 Resource Manager 的意義
在深入了解詳細資料之前，讓我們看看 IaaS 資源上資料平面與管理平面作業之間的差異。

* 「管理/控制平面」說明進入管理/控制平面或 API 以便修改資源的呼叫。 例如，建立 VM、重新啟動 VM 以及將虛擬網路更新成使用新子網路等作業皆可管理執行中的資源。 它們並不直接影響對執行個體的連線。
*  (應用程式) 說明應用程式本身的執行階段，並牽涉到與不通過 Azure API 的執行個體進行互動。 不論是存取您的網站，還是從執行中的 SQL Server 或 MongoDB 伺服器提取資料，皆會被視為是資料平面或應用程式互動。 從儲存體帳戶複製 Blob 以及存取公用 IP 位址以透過 RDP 或 SSH 進入虛擬機器也屬於資料平面。 這些作業會讓應用程式繼續跨計算、網路和儲存體執行。

![說明管理/控制平面與資料平面之間差異的螢幕擷取畫面](../articles/virtual-machines/media/virtual-machines-windows-migration-classic-resource-manager/data-control-plane.png)

> [!NOTE]
> 在一些移轉案例中，Azure 平台會將您的虛擬機器停止、解除配置及重新啟動。 這會造成短暫的資料平面停機時間。
>
>

## <a name="the-migration-experience"></a>移轉體驗
開始進行移轉體驗之前，有下列幾點建議事項：

* 確定您要移轉的資源未使用任何不支援的功能或組態。 通常，平台會偵測這些問題並產生錯誤。
* 如果您有不在虛擬網路中的 VM，則在準備作業過程中，會將這些 VM 停止並解除配置。 如果您不想失去公用 IP 位址，請在觸發準備作業之前，先了解如何保留 IP 位址。 不過，如果 VM 位於虛擬網路中，它們就不會被停止並解除配置。
* 規劃非上班時間的移轉，以便因應移轉期間可能發生的任何非預期失敗。
* 使用 PowerShell、命令列介面 (CLI) 命令或 REST API 來下載現行的 VM 組態，以便在完成準備步驟之後能夠更容易進行驗證。
* 先更新用來處理 Resource Manager 部署模型的自動化/作業化指令碼，再開始移轉。 當資源處於已準備就緒狀態時，您可以視需要執行 GET 作業。
* 在移轉完成之後，評估傳統 IaaS 資源上設定的 RBAC 原則並備妥計劃。

移轉工作流程如下

![顯示移轉工作流程的螢幕擷取畫面](../articles/virtual-machines/windows/media/migration-classic-resource-manager/migration-workflow.png)

> [!NOTE]
> 下列各節描述的所有作業都是等冪的。 如果您有除了不支援的功能或組態錯誤以外的任何問題，建議您重新嘗試準備、中止或認可作業。 平台將會重新嘗試該動作。
>
>

### <a name="validate"></a>驗證
驗證作業是移轉程序的第一個步驟。 此步驟的目標是要在背景針對進行移轉的資源執行資料分析，如果資源能夠進行移轉，便傳回成功/失敗。

您需選取要進行移轉驗證的虛擬網路或託管服務 (如果它不是虛擬網路)。

* 如果資源不能進行移轉，Azure 平台將會列出不支援移轉該資源的所有原因。

驗證儲存體服務時，您會發現資源群組中已移轉帳戶的名稱與您儲存體帳戶的名稱相同，但會附加 "-Migrated"。  例如，如果您的儲存體帳戶名為 "mystorage"，您會發現資源群組中支援 Azure Resource Manager 的資源會命名為 "mystorage-Migrated"，而且它會包含名為 "mystorage" 的儲存體帳戶。

### <a name="prepare"></a>準備
準備作業是移轉程序的第二個步驟。 這個步驟的目標是要模擬將 IaaS 資源從傳統資源轉換為 Resource Manager 資源的轉換過程，並以並排方式呈現此過程以供您用視覺化方式檢視。

您需選取要為移轉做準備的虛擬網路或託管服務 (如果它不是虛擬網路)。

* 如果資源不能進行移轉，Azure 平台將會停止移轉程序並列出準備作業失敗的原因。
* 如果資源能夠進行移轉，Azure 平台會先鎖定進行移轉之資源的管理平面作業。 例如，您會無法將資料磁碟新增至進行移轉的 VM。

接著，Azure 平台會開始將移轉中資源的中繼資料從傳統移轉至 Resource Manager。

準備作業完成之後，您將可以選擇在傳統和 Resource Manager 中將資源視覺化。 Azure 平台會為傳統部署模型中的每個雲端服務，建立一個採用 `cloud-service-name>-Migrated`模式的資源群組名稱。

> [!NOTE]
> 無法選取針對已移轉資源所建立的資源群組名稱 (例如 "-Migrated")，但在完成移轉之後，您可以使用 Azure Resource Manager 移動功能來將資源移動到您所需的任何資源群組。 若要深入了解此概念，請參閱[將資源移動到新的資源群組或訂用帳戶](../articles/resource-group-move-resources.md)。

以下兩個畫面顯示成功進行準備作業之後的結果。 第一個畫面顯示包含原始雲端服務的資源群組。 第二個畫面顯示新的 "-Migrated" 資源群組，其中包含對等的 Azure Resource Manager 資源。

![顯示入口網站傳統雲端服務的螢幕擷取畫面](../articles/virtual-machines/windows/media/migration-classic-resource-manager/portal-classic.png)

![顯示入口網站 Azure Resource Manager 資源處於準備狀態的螢幕擷取畫面](../articles/virtual-machines/windows/media/migration-classic-resource-manager/portal-arm.png)

> [!NOTE]
> 在這個移轉階段中，會將不在傳統「虛擬網路」中的「虛擬機器」停止並解除配置。
>
>

### <a name="check-manual-or-scripted"></a>檢查 (手動或透過指令碼)
在檢查步驟中，您可以視需要使用您稍早下載的組態來驗證移轉是否正確無誤。 或者，您也可以登入入口網站並抽樣檢查屬性和資源，以驗證中繼資料移轉是否正確無誤。

如果您移轉的是虛擬網路，則虛擬機器的大部分組態都不會重新啟動。 對於這些 VM 上的應用程式，您可以確認應用程式是否仍會啟動並執行。

您可以測試您的監視/自動化和作業指令碼，以查看 VM 是否如預期方式運作，以及更新後的指令碼是否正常運作。 當資源處於已準備就緒的狀態時，只支援 GET 作業。

系統並未設定您必須在哪個期限之前認可移轉。 您可以在此狀態停留任何長度的時間。 不過，這些資源的管理平面將會處於鎖定狀態，直到您進行中止或認可為止。

如果您發現任何問題，您一律可以中止移轉，並返回傳統部署模型。 在您返回之後，Azure 平台將會開放對資源的平面管理作業，讓您可以在傳統部署模型中繼續對這些 VM 進行一般作業。

### <a name="abort"></a>中止
「中止」是選擇性步驟，您可以使用此步驟將您的變更還原至傳統部署模型並停止移轉。

> [!NOTE]
> 在您觸發了認可作業之後，就無法執行此作業。     
>
>

### <a name="commit"></a>認可
完成驗證之後，您便可以認可移轉。 資源不會再出現在傳統部署模型中，而只有在 Resource Manager 部署模型中才能使用這些資源。 只能在新入口網站中管理已移轉的資源。

> [!NOTE]
> 這是一種等冪作業。 如果發生失敗，建議您重新嘗試執行該作業。 如果持續發生失敗，請建立支援票證，或是在我們的 [VM 論壇](https://social.msdn.microsoft.com/Forums/azure/home?forum=WAVirtualMachinesforWindows)上建立一篇標籤為 ClassicIaaSMigration 的論壇文章。
>
>
<br>
以下是移轉程序期間的步驟流程圖

![顯示移轉步驟的螢幕擷取畫面](../articles/virtual-machines/windows/media/migration-classic-resource-manager/migration-flow.png)

## <a name="translation-of-classic-to-azure-resource-manager-resources"></a>從傳統轉譯成 Azure Resource Manager 資源
下表提供傳統和 Resource Manager 的資源表示法。 目前不支援其他功能和資源。

| 傳統表示法 | Resource Manager 表示法 | 詳細資訊 |
| --- | --- | --- |
| 雲端服務名稱 |DNS 名稱 |在移轉期間，會以命名樣式 `<cloudservicename>-migrated`為每個雲端服務建立新的資源群組。 此資源群組包含您的所有資源。 雲端服務名稱會成為與公用 IP 位址關聯的 DNS 名稱。 |
| 虛擬機器 |虛擬機器 |VM 特定屬性會原封不動地移轉過去。 有些 osProfile 資訊 (例如電腦名稱) 不會儲存在傳統部署模型中，因此移轉後會保留空白。 |
| 連接至 VM 的磁碟資源 |連接至 VM 的隱含磁碟 |在 Resource Manager 部署模型中，並未將磁碟塑造成最上層資源。 這些磁碟是被當作 VM 底下的隱含磁碟來移轉。 目前只支援連接至 VM 的磁碟。 Resource Manager VM 現在可以使用傳統儲存體帳戶，這可讓您不須進行任何更新，即可輕鬆移轉磁碟。 |
| VM 擴充功能 |VM 擴充功能 |所有資源擴充功能 (XML 擴充功能除外) 都會從傳統部署模型移轉出來。 |
| 虛擬機器憑證 |Azure 金鑰保存庫中的憑證 |如果雲端服務包含服務憑證，系統就會為每個雲端服務建立一個新的 Azure 金鑰保存庫，然後將憑證移至該金鑰保存庫。 VM 將會更新為參照該金鑰保存庫中的憑證。 <br><br> **注意︰**請不要刪除金鑰保存庫，因為它可能會造成 VM 進入失敗狀態。 我們正努力提升後端中的項目，因此可以放心刪除或移動金鑰保存庫與 VM 至新的訂用帳戶。 |
| WinRM 組態 |osProfile 下的 WinRM 組態 |「Windows 遠端管理」組態在移轉過程中會原封不動地移過去。 |
| 可用性設定組屬性 |可用性設定組資源 | 可用性設定組規格是傳統部署模型中 VM 上的屬性。 在移轉過程中，可用性設定組會變成最上層資源。 不支援下列組態：每個雲端服務有多個可用性設定組，或是一或多個可用性設定組帶有不屬於雲端服務中任何可用性設定組的 VM。 |
| VM 上的網路組態 |主要網路介面 |移轉之後，VM 上的網路組態就會顯示為主要網路介面資源。 VM 如果不在虛擬網路中，其內部 IP 位址在移轉期間將會變更。 |
| VM 上的多個網路介面 |網路介面 |如果 VM 有多個關聯的網路介面，則在移轉至 Resource Manager 部署模型的過程中，每個網路介面以及所有的屬性都會成為最上層資源。 |
| 負載平衡的端點集 |負載平衡器 |在傳統部署模型中，平台已為每個雲端服務指派一個隱含的負載平衡器。 在移轉期間，會建立新的負載平衡器資源，而負載平衡端點集則會成為負載平衡器規則。 |
| 傳入的 NAT 規則 |傳入的 NAT 規則 |在移轉期間，VM 上定義的輸入端點會轉換成負載平衡器下的輸入網路位址轉譯規則。 |
| VIP 位址 |具 DNS 名稱的公用 IP 位址 |虛擬 IP 位址會變成公用 IP 位址並與負載平衡器產生關聯。 |
| 虛擬網路 |虛擬網路 |虛擬網路會與其所有屬性一起移轉至 Resource Manager 部署模型。 將會建立名為 `-migrated`的新資源群組。 |
| 保留的 IP |搭配靜態配置方法的公用 IP 位址 |與負載平衡器關聯的保留 IP 會隨著雲端服務或虛擬機器的移轉一併移轉。 目前不支援移轉未關聯的保留 IP。 |
| 每一個 VM 的公用 IP 位址 |搭配動態配置方法的公用 IP 位址 |與 VM 關聯的公用 IP 位址會轉換成公用 IP 位址資源，且配置方法會設定為靜態。 |
| NSG |NSG |在移轉至 Resource Manager 部署模型的過程中，會複製與子網路關聯的網路安全性群組。 在移轉期間不會移除傳統部署模型中的 NSG。 不過，在移轉進行時，會封鎖 NSG 的管理平面作業。 |
| DNS 伺服器 |DNS 伺服器 |與虛擬網路或 VM 關聯的 DNS 伺服器，會在對應的資源移轉過程中，與其所有屬性一起移轉。 |
| UDR |UDR |在移轉至 Resource Manager 部署模型的過程中，會複製與子網路關聯的使用者定義路由。 在移轉期間不會移除傳統部署模型中的 UDR。 不過，移轉進行時，會封鎖 UDR 的管理平面作業。 |
| VM 網路組態上的 IP 轉送屬性 |NIC 上的 IP 轉送屬性 |在移轉期間，VM 上的 IP 轉送屬性會轉換成網路介面上的屬性。 |
| 具有多個 IP 的負載平衡器 |具有多個公用 IP 資源的負載平衡器 |與負載平衡器關聯的每個公用 IP 在移轉後都會轉換成公用 IP 資源，並與負載平衡器產生關聯。 |
| VM 上的內部 DNS 名稱 |NIC 上的內部 DNS 名稱 |在移轉期間，VM 的內部 DNS 尾碼會移轉至 NIC 上名為 "InternalDomainNameSuffix" 的唯讀屬性。 尾碼在移轉後保持不變，VM 解析應該會像之前一樣繼續運作。 |
| 虛擬網路閘道 |虛擬網路閘道 |不變更虛擬網路閘道內容下進行移轉。 與閘道相關聯的 VIP 也不會變更。 |
| 區域網路網站 |區域網路閘道 |不變更區域網路網站的內容下移轉到稱為本機網路閘道的新資源。 這表示內部部署位址首碼與遠端閘道的 IP。 |
| 連線參考 |連線 |閘道和網路組態中的區域網路網站之間的連線參考在移轉之後會以資源管理員中稱為連線的新建立資源代表。 網路組態檔中連線參考的所有屬性都會在不變更下複製到新建立的連線資源。 傳統 VNet 對 VNet 連線能力的實現方式為建立兩個區域網路網站的 IPsec 通道以代表 Vnet。 這會在資源管理員模型中轉換為 Vnet2Vnet 連線類型，而不需要區域網路閘道。 |

## <a name="changes-to-your-automation-and-tooling-after-migration"></a>移轉之後對自動化及工具的變更
在將資源從「傳統」部署模型移轉至 Resource Manager 部署模型的過程中，您將必須更新現有的自動化或工具，以確保它在移轉之後仍可繼續運作。
